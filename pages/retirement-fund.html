<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-M92225DERV"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-M92225DERV');
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="ë…¸í›„ í•„ìš”ìê¸ˆ ì‚°ì¶œ, ì›” ìƒí™œë¹„ ì—­ì‚°, ìì‚° ì¸ì¶œ ì „ëµ ì‹œë®¬ë ˆì´ì…˜. ì€í‡´ í›„ ìì‚° ì†Œì§„ ì‹œì ì„ ë¯¸ë¦¬ í™•ì¸í•˜ì„¸ìš”.">
  <title>ë…¸í›„ìê¸ˆ ì„¤ê³„ - ì—°ê¸ˆ í¬í„¸</title>
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css">
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/calculator.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
</head>
<body>
  <nav id="main-nav"></nav>

  <div class="container">
    <div class="page-header fade-in">
      <h1 class="page-title">ë…¸í›„ìê¸ˆ ì„¤ê³„</h1>
      <p class="page-subtitle">ì€í‡´ í›„ í•„ìš”ìê¸ˆ, ìì‚° ì†Œì§„ ì‹œì , ì¸ì¶œ ì „ëµì„ ì„¤ê³„í•©ë‹ˆë‹¤</p>
    </div>

    <div class="info-box info fade-in">
      <span class="icon">ğŸ’¡</span>
      <div>
        <strong>ë…¸í›„ ì ì • ìƒí™œë¹„ ì°¸ê³  (2025ë…„, í•œêµ­ë³´ê±´ì‚¬íšŒì—°êµ¬ì›)</strong><br>
        â€¢ ê°œì¸: ìµœì†Œ 131ë§Œì› / ì ì • 193ë§Œì› &nbsp;&nbsp;â€¢ ë¶€ë¶€: ìµœì†Œ 198ë§Œì› / ì ì • 294ë§Œì›
      </div>
    </div>

    <div class="tabs fade-in">
      <button class="tab-btn active" onclick="RetireFund.switchTab('need', this)">í•„ìš”ìê¸ˆ ê³„ì‚°</button>
      <button class="tab-btn" onclick="RetireFund.switchTab('asset', this)">ìì‚° ì†Œì§„ ë¶„ì„</button>
      <button class="tab-btn" onclick="RetireFund.switchTab('withdraw', this)">ì¸ì¶œ ì „ëµ ë¹„êµ</button>
    </div>

    <!-- ==============================
         íƒ­1: í•„ìš”ìê¸ˆ ê³„ì‚°
         ============================== -->
    <div class="tab-content active" id="tab-need">
      <div class="calc-layout">
        <div class="calc-input-panel">
          <div class="card">
            <h2 class="card-title"><span class="card-icon">ğŸ“</span>ê¸°ë³¸ ì¡°ê±´</h2>
            <form id="rfNeedForm">
              <div class="form-group">
                <label class="form-label">ì€í‡´ ë‚˜ì´</label>
                <div class="input-group">
                  <input type="number" class="form-input" name="retireAge" value="60" min="50" max="75">
                  <span class="input-suffix">ì„¸</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ê¸°ëŒ€ìˆ˜ëª…</label>
                <div class="input-group">
                  <input type="number" class="form-input" name="endAge" value="90" min="70" max="110">
                  <span class="input-suffix">ì„¸</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ì›” í¬ë§ ìƒí™œë¹„ <span class="unit">(ë§Œì›)</span></label>
                <div class="input-group">
                  <input type="text" class="form-input" name="monthlyExpense" data-type="money" value="250">
                  <span class="input-suffix">ë§Œì›</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ë¬¼ê°€ìƒìŠ¹ë¥  <span class="unit">(%)</span></label>
                <div class="form-range-container">
                  <input type="range" class="form-range" name="inflation" min="1" max="5" step="0.5" value="2.5" oninput="document.getElementById('infVal').textContent=this.value+'%'">
                  <span class="range-value" id="infVal">2.5%</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">íˆ¬ììˆ˜ìµë¥  <span class="unit">(%)</span></label>
                <div class="form-range-container">
                  <input type="range" class="form-range" name="returnRate" min="1" max="8" step="0.5" value="4" oninput="document.getElementById('retVal').textContent=this.value+'%'">
                  <span class="range-value" id="retVal">4%</span>
                </div>
              </div>
              <button type="button" class="btn btn-primary btn-block btn-lg" onclick="RetireFund.calcNeed()">ê³„ì‚°í•˜ê¸°</button>
            </form>
          </div>
        </div>

        <div class="calc-result-panel">
          <div id="nd-empty" class="card">
            <div class="empty-result">
              <div class="icon">ğŸ¦</div>
              <div class="text">ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ê³„ì‚°í•˜ê¸°ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
            </div>
          </div>

          <div id="nd-result" class="hidden">
            <div class="result-banner fade-in">
              <div class="label">ì€í‡´ ì‹œì  í•„ìš”ìê¸ˆ (í˜„ì¬ê°€ì¹˜)</div>
              <div class="amount" id="nd-pv">-</div>
              <div class="sub" id="nd-info">-</div>
            </div>

            <div class="result-mini-grid fade-in">
              <div class="result-mini">
                <div class="label">ëª…ëª© ì´ í•„ìš”ì•¡</div>
                <div class="value" id="nd-nominal">-</div>
              </div>
              <div class="result-mini">
                <div class="label">ì€í‡´ ê¸°ê°„</div>
                <div class="value" id="nd-years">-</div>
              </div>
              <div class="result-mini">
                <div class="label">80ì„¸ ì‹œ ì›”ìƒí™œë¹„</div>
                <div class="value orange" id="nd-80cost">-</div>
              </div>
            </div>

            <div class="card fade-in">
              <h2 class="card-title"><span class="card-icon">ğŸ“Š</span>ì—°ê°„ í•„ìš”ìƒí™œë¹„ ì¶”ì´ (ë¬¼ê°€ë°˜ì˜)</h2>
              <div class="chart-container tall">
                <canvas id="ndChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==============================
         íƒ­2: ìì‚° ì†Œì§„ ë¶„ì„
         ============================== -->
    <div class="tab-content" id="tab-asset">
      <div class="calc-layout">
        <div class="calc-input-panel">
          <div class="card">
            <h2 class="card-title"><span class="card-icon">ğŸ“</span>ìì‚° ë° ì—°ê¸ˆ ì •ë³´</h2>
            <form id="rfAssetForm">
              <div class="form-group">
                <label class="form-label">ë³´ìœ  ê¸ˆìœµìì‚° <span class="unit">(ë§Œì›)</span></label>
                <div class="input-group">
                  <input type="text" class="form-input" name="totalAssets" data-type="money" value="50,000">
                  <span class="input-suffix">ë§Œì›</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ì›” ì—°ê¸ˆ ìˆ˜ë ¹ì•¡ <span class="unit">(ë§Œì›)</span></label>
                <div class="input-group">
                  <input type="text" class="form-input" name="monthlyPension" data-type="money" value="150">
                  <span class="input-suffix">ë§Œì›</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ì›” í¬ë§ ìƒí™œë¹„ <span class="unit">(ë§Œì›)</span></label>
                <div class="input-group">
                  <input type="text" class="form-input" name="monthlyExpense" data-type="money" value="250">
                  <span class="input-suffix">ë§Œì›</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ì€í‡´ ë‚˜ì´</label>
                <div class="input-group">
                  <input type="number" class="form-input" name="retireAge" value="60" min="50" max="75">
                  <span class="input-suffix">ì„¸</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ê¸°ëŒ€ìˆ˜ëª…</label>
                <div class="input-group">
                  <input type="number" class="form-input" name="endAge" value="90" min="70" max="110">
                  <span class="input-suffix">ì„¸</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">íˆ¬ììˆ˜ìµë¥  / ë¬¼ê°€ìƒìŠ¹ë¥  <span class="unit">(%)</span></label>
                <div class="form-inline">
                  <div class="form-group">
                    <div class="input-group">
                      <input type="number" class="form-input" name="returnRate" value="4" step="0.5" min="0" max="10">
                      <span class="input-suffix">%ìˆ˜ìµ</span>
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="input-group">
                      <input type="number" class="form-input" name="inflation" value="2.5" step="0.5" min="0" max="8">
                      <span class="input-suffix">%ë¬¼ê°€</span>
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-primary btn-block btn-lg" onclick="RetireFund.calcAsset()">ë¶„ì„í•˜ê¸°</button>
            </form>
          </div>
        </div>

        <div class="calc-result-panel">
          <div id="as-empty" class="card">
            <div class="empty-result">
              <div class="icon">ğŸ“‰</div>
              <div class="text">ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ë¶„ì„í•˜ê¸°ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
            </div>
          </div>

          <div id="as-result" class="hidden">
            <div class="result-mini-grid fade-in">
              <div class="result-mini">
                <div class="label">ìì‚°ì—ì„œ ì›” ì¸ì¶œ</div>
                <div class="value" id="as-from-asset">-</div>
              </div>
              <div class="result-mini">
                <div class="label">ì—°ê¸ˆ ìˆ˜ë ¹</div>
                <div class="value green" id="as-pension">-</div>
              </div>
              <div class="result-mini">
                <div class="label">ì›” ì‚¬ìš© ê°€ëŠ¥</div>
                <div class="value" id="as-total-monthly">-</div>
              </div>
              <div class="result-mini">
                <div class="label">ê³¼ë¶€ì¡±</div>
                <div class="value" id="as-gap">-</div>
              </div>
            </div>

            <div class="info-box fade-in" id="as-status-box">
              <span class="icon" id="as-status-icon">-</span>
              <div id="as-status-text"></div>
            </div>

            <div class="card fade-in">
              <h2 class="card-title"><span class="card-icon">ğŸ“Š</span>ìì‚° ì†Œì§„ ì¶”ì´</h2>
              <div class="chart-container tall">
                <canvas id="asChart"></canvas>
              </div>
            </div>

            <!-- ì•„ë²„ë‹˜ í”¼ë“œë°± ë°˜ì˜: ì—°ë ¹ë³„ ìƒì„¸ ìì‚° íë¦„í‘œ -->
            <div class="card fade-in" id="as-timeline-card">
              <h2 class="card-title"><span class="card-icon">ğŸ“‹</span>ì—°ë ¹ë³„ ìì‚° íë¦„ ìƒì„¸ (ë¬¼ê°€ë°˜ì˜)</h2>
              <p class="card-desc">êµ­ë¯¼ì—°ê¸ˆê³¼ ìƒí™œë¹„ê°€ ë¬¼ê°€ìƒìŠ¹ë¥ ì— ë”°ë¼ ë™ë°˜ ìƒìŠ¹í•˜ëŠ” ê²ƒì„ ë°˜ì˜í•œ ìƒì„¸ ìˆ˜ì¹˜ì…ë‹ˆë‹¤.</p>
              <div class="table-responsive">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th class="col-center">ë‚˜ì´</th>
                      <th>ì›” ìƒí™œë¹„</th>
                      <th>ì›” êµ­ë¯¼ì—°ê¸ˆ</th>
                      <th>ì›” ë¶€ì¡±ì•¡</th>
                      <th class="col-highlight">ë‚¨ëŠ” ìì‚°</th>
                    </tr>
                  </thead>
                  <tbody id="as-timeline-body">
                    <!-- ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ìƒì„± -->
                  </tbody>
                </table>
              </div>
              <div class="info-box info mt-md">
                <span class="icon">ğŸ’¡</span>
                <div>êµ­ë¯¼ì—°ê¸ˆì€ ë²•ì ìœ¼ë¡œ ë§¤ë…„ ë¬¼ê°€ìƒìŠ¹ë¥ ë§Œí¼ ì¸ìƒë˜ì–´ ì‹¤ì§ˆ ê°€ì¹˜ê°€ ë³´ì „ë©ë‹ˆë‹¤. ìœ„ í‘œëŠ” ì´ ì¸ìƒë¶„ê¹Œì§€ í¬í•¨í•˜ì—¬ ê³„ì‚°ëœ ê²°ê³¼ì…ë‹ˆë‹¤.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==============================
         íƒ­3: ì¸ì¶œ ì „ëµ ë¹„êµ
         ============================== -->
    <div class="tab-content" id="tab-withdraw">
      <div class="calc-layout">
        <div class="calc-input-panel">
          <div class="card">
            <h2 class="card-title"><span class="card-icon">ğŸ“</span>ì¸ì¶œ ì „ëµ ì¡°ê±´</h2>
            <form id="rfWithdrawForm">
              <div class="form-group">
                <label class="form-label">ë³´ìœ  ìì‚° <span class="unit">(ë§Œì›)</span></label>
                <div class="input-group">
                  <input type="text" class="form-input" name="assets" data-type="money" value="50,000">
                  <span class="input-suffix">ë§Œì›</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ì—°ê°„ ì •ì•¡ ì¸ì¶œ <span class="unit">(ë§Œì›)</span></label>
                <div class="input-group">
                  <input type="text" class="form-input" name="annualWithdraw" data-type="money" value="2,400">
                  <span class="input-suffix">ë§Œì›</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ì •ë¥  ì¸ì¶œë¥  <span class="unit">(%)</span></label>
                <div class="form-range-container">
                  <input type="range" class="form-range" name="withdrawRate" min="2" max="8" step="0.5" value="4" oninput="document.getElementById('wrVal').textContent=this.value+'%'">
                  <span class="range-value" id="wrVal">4%</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">íˆ¬ììˆ˜ìµë¥  <span class="unit">(%)</span></label>
                <div class="input-group">
                  <input type="number" class="form-input" name="returnRate" value="4" step="0.5" min="0" max="10">
                  <span class="input-suffix">%</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ë¬¼ê°€ìƒìŠ¹ë¥  <span class="unit">(%)</span></label>
                <div class="input-group">
                  <input type="number" class="form-input" name="inflation" value="2.5" step="0.5" min="0" max="8">
                  <span class="input-suffix">%</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ì‹œë®¬ë ˆì´ì…˜ ê¸°ê°„</label>
                <div class="input-group">
                  <input type="number" class="form-input" name="simYears" value="30" min="10" max="50">
                  <span class="input-suffix">ë…„</span>
                </div>
              </div>
              <button type="button" class="btn btn-primary btn-block btn-lg" onclick="RetireFund.calcWithdraw()">ë¹„êµí•˜ê¸°</button>
            </form>
          </div>
        </div>

        <div class="calc-result-panel">
          <div id="wd-empty" class="card">
            <div class="empty-result">
              <div class="icon">ğŸ“‹</div>
              <div class="text">ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ë¹„êµí•˜ê¸°ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
              <div class="sub-text">ì •ì•¡/ì •ë¥ /ë²„í‚· 3ê°€ì§€ ì¸ì¶œ ì „ëµì„ ë¹„êµí•©ë‹ˆë‹¤</div>
            </div>
          </div>

          <div id="wd-result" class="hidden">
            <div class="scenario-cards fade-in">
              <div class="scenario-card">
                <div class="scenario-label primary">ì •ì•¡ ì¸ì¶œ</div>
                <div class="scenario-desc">ë§¤ë…„ ê³ ì • ê¸ˆì•¡ ì¸ì¶œ (ë¬¼ê°€ ì¡°ì •)</div>
                <div class="scenario-value" id="wd-fixed-last">-</div>
                <div class="scenario-desc" id="wd-fixed-desc">-</div>
              </div>
              <div class="scenario-card">
                <div class="scenario-label secondary">ì •ë¥  ì¸ì¶œ</div>
                <div class="scenario-desc">ì”ì•¡ì˜ ì¼ì • ë¹„ìœ¨ ì¸ì¶œ</div>
                <div class="scenario-value" id="wd-rate-last">-</div>
                <div class="scenario-desc" id="wd-rate-desc">-</div>
              </div>
              <div class="scenario-card">
                <div class="scenario-label accent">ë²„í‚· ì „ëµ</div>
                <div class="scenario-desc">ë‹¨ê¸°/ì¤‘ê¸°/ì¥ê¸° 3ê°œ ë²„í‚·</div>
                <div class="scenario-value" id="wd-bucket-last">-</div>
                <div class="scenario-desc" id="wd-bucket-desc">-</div>
              </div>
            </div>

            <div class="card fade-in">
              <h2 class="card-title"><span class="card-icon">ğŸ“Š</span>ì¸ì¶œ ì „ëµë³„ ìì‚° ì¶”ì´</h2>
              <div class="chart-container tall">
                <canvas id="wdChart"></canvas>
              </div>
            </div>

            <div class="card fade-in">
              <h2 class="card-title"><span class="card-icon">ğŸ“‹</span>ì „ëµë³„ íŠ¹ì§• ë¹„êµ</h2>
              <div class="table-responsive">
                <table class="data-table">
                  <thead>
                    <tr><th>ì „ëµ</th><th>ì¥ì </th><th>ë‹¨ì </th><th>ì í•© ëŒ€ìƒ</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><strong>ì •ì•¡ ì¸ì¶œ</strong></td>
                      <td>ìƒí™œë¹„ ì˜ˆì¸¡ ìš©ì´</td>
                      <td>í•˜ë½ì¥ì— ìì‚° ê¸‰ê°</td>
                      <td>ì•ˆì •ì  í˜„ê¸ˆíë¦„ í•„ìš” ì‹œ</td>
                    </tr>
                    <tr>
                      <td><strong>ì •ë¥  ì¸ì¶œ</strong></td>
                      <td>ìì‚° ê³ ê°ˆ ë°©ì§€</td>
                      <td>ì¸ì¶œì•¡ ë³€ë™ í¼</td>
                      <td>ìœ ì—°í•œ ì§€ì¶œ ê°€ëŠ¥ ì‹œ</td>
                    </tr>
                    <tr>
                      <td><strong>ë²„í‚· ì „ëµ</strong></td>
                      <td>ì•ˆì •+ì„±ì¥ ê· í˜•</td>
                      <td>ê´€ë¦¬ ë³µì¡</td>
                      <td>ìì‚°ê·œëª¨ í° ê²½ìš°</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer id="footer"></footer>

  <script src="../js/constants.js"></script>
  <script src="../js/calculator-engine.js"></script>
  <script src="../js/common.js"></script>
  <script>
    const RetireFund = {
      switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        btn.classList.add('active');
        APP.input.initMoneyFields();
      },

      calcNeed() {
        const calcBtn = document.querySelector('#rfNeedForm .btn-primary');
        APP.button.loading(calcBtn);
        const form = document.getElementById('rfNeedForm');
        const retireAge = Number(form.retireAge.value) || 60;
        const endAge = Number(form.endAge.value) || 90;
        const monthlyExpense = Number(form.monthlyExpense.value.replace(/[^0-9]/g, '')) * 10000;
        const monthlyPension = form.monthlyPension ? (Number(form.monthlyPension.value.replace(/[^0-9]/g, '')) * 10000 || 0) : 0;
        const inflation = Number(form.inflation.value) / 100;
        const returnRate = Number(form.returnRate.value) / 100;

        // ì•„ë²„ë‹˜ í”¼ë“œë°± ë°˜ì˜: ë¶€ì¡±í•œ ì°¨ì•¡(Gap)ì— ëŒ€í•´ì„œë§Œ í•„ìš”ìê¸ˆ ì—­ì‚°
        const netExpense = Math.max(monthlyExpense - monthlyPension, 0);
        const result = CalcEngine.retirementFund.calcRequiredFund(netExpense, retireAge, endAge, inflation, returnRate);

        // 80ì„¸ ì‹œì  ì›”ìƒí™œë¹„ ë¶€ì¡±ë¶„
        const years80 = Math.max(80 - retireAge, 0);
        const cost80 = netExpense * Math.pow(1 + inflation, years80);

        document.getElementById('nd-empty').classList.add('hidden');
        document.getElementById('nd-result').classList.remove('hidden');

        document.getElementById('nd-pv').textContent = APP.format.manwon(result.presentValue);
        document.getElementById('nd-info').textContent = `ì—°ê¸ˆ ì™¸ ì›” ë¶€ì¡±ì•¡ ${APP.format.manwon(netExpense)}ì„ ë©”ê¾¸ê¸° ìœ„í•´ ì€í‡´ ì‹œì ì— í•„ìš”í•œ ì¼ì‹œê¸ˆ`;
        document.getElementById('nd-nominal').textContent = APP.format.manwon(result.nominalTotal);
        document.getElementById('nd-years').textContent = result.years + 'ë…„';
        document.getElementById('nd-80cost').textContent = APP.format.manwon(cost80);

        // ì°¨íŠ¸
        const ages = result.yearlyData.map(d => d.age + 'ì„¸');
        const expenses = result.yearlyData.map(d => Math.round(d.annualExpense / 10000));

        APP.chart.create('ndChart', {
          type: 'bar',
          data: {
            labels: ages,
            datasets: [{
              label: 'ì—°ê°„ ì¶”ê°€ ë¶€ì¡±ì•¡ (ë§Œì›)',
              data: expenses,
              backgroundColor: expenses.map((_, i) => {
                const ratio = i / expenses.length;
                return ratio < 0.33 ? APP.chart.colors.primaryAlpha
                  : ratio < 0.66 ? APP.chart.colors.accentAlpha
                  : APP.chart.colors.dangerAlpha;
              }),
              borderColor: expenses.map((_, i) => {
                const ratio = i / expenses.length;
                return ratio < 0.33 ? APP.chart.colors.primary
                  : ratio < 0.66 ? APP.chart.colors.accent
                  : APP.chart.colors.danger;
              }),
              borderWidth: 1,
            }]
          },
          options: {
            plugins: {
              title: { display: true, text: 'ì—°ê°„ ë¶€ì¡±ì•¡ ì¶”ì´ (ë¬¼ê°€ìƒìŠ¹ ë°˜ì˜)', font: { size: 16 } }
            },
            scales: { y: { title: { display: true, text: 'ë§Œì›' }, beginAtZero: true } }
          }
        });

        APP.storage.saveForm('rfNeedForm');
        requestAnimationFrame(() => APP.button.reset(calcBtn));
      },

      calcAsset() {
        const calcBtn = document.querySelector('#rfAssetForm .btn-primary');
        APP.button.loading(calcBtn);
        const form = document.getElementById('rfAssetForm');
        const getVal = (name) => Number(form[name].value.replace(/[^0-9]/g, '')) * 10000;

        const totalAssets = getVal('totalAssets');
        const monthlyPension = getVal('monthlyPension');
        const monthlyExpense = getVal('monthlyExpense');
        const retireAge = Number(form.retireAge.value) || 60;
        const endAge = Number(form.endAge.value) || 90;
        const returnRate = Number(form.returnRate.value) / 100;
        const inflation = Number(form.inflation.value) / 100;

        const result = CalcEngine.retirementFund.calcAvailableMonthly(
          totalAssets, monthlyPension, retireAge, endAge, returnRate, inflation
        );

        const gap = result.totalMonthly - monthlyExpense;

        // ì•„ë²„ë‹˜ í”¼ë“œë°± ë°˜ì˜: ìƒì„¸ íƒ€ì„ë¼ì¸ ë°ì´í„° ìƒì„±
        let currentBalance = totalAssets;
        const timelineData = [];
        let firstDepletionAge = null;

        for (let y = 0; y <= (endAge - retireAge); y++) {
          const age = retireAge + y;
          const currentExp = monthlyExpense * Math.pow(1 + inflation, y);
          const currentPen = monthlyPension * Math.pow(1 + inflation, y);
          const currentGap = currentExp - currentPen;

          if (y > 0) {
            currentBalance = currentBalance * (1 + returnRate) - (currentGap * 12);
          }
          if (currentBalance < 0) {
            currentBalance = 0;
            if (firstDepletionAge === null) firstDepletionAge = age;
          }

          if (y % 5 === 0 || age === endAge) {
            timelineData.push({
              age,
              expense: Math.round(currentExp),
              pension: Math.round(currentPen),
              gap: Math.round(currentGap),
              balance: Math.max(0, Math.round(currentBalance))
            });
          }
        }

        document.getElementById('as-empty').classList.add('hidden');
        document.getElementById('as-result').classList.remove('hidden');

        // í‘œ ì—…ë°ì´íŠ¸
        const tbody = document.getElementById('as-timeline-body');
        tbody.innerHTML = timelineData.map(d => `
          <tr>
            <td class="col-center col-bold">${d.age}ì„¸</td>
            <td>${APP.format.manwon(d.expense)}</td>
            <td class="col-positive">${APP.format.manwon(d.pension)}</td>
            <td class="col-negative">${APP.format.manwon(d.gap)}</td>
            <td class="col-highlight">${APP.format.manwon(d.balance)}</td>
          </tr>
        `).join('');

        document.getElementById('as-from-asset').textContent = APP.format.manwon(result.monthlyFromAssets);
        document.getElementById('as-pension').textContent = APP.format.manwon(monthlyPension);
        document.getElementById('as-total-monthly').textContent = APP.format.manwon(result.totalMonthly);

        const gapEl = document.getElementById('as-gap');
        if (gap >= 0) {
          gapEl.textContent = '+' + APP.format.manwon(gap);
          gapEl.className = 'value green';
        } else {
          gapEl.textContent = APP.format.manwon(gap);
          gapEl.className = 'value red';
        }

        const statusBox = document.getElementById('as-status-box');
        const finalDepletionAge = firstDepletionAge || endAge;
        if (finalDepletionAge >= endAge) {
          statusBox.className = 'info-box success fade-in';
          document.getElementById('as-status-icon').textContent = 'âœ…';
          document.getElementById('as-status-text').innerHTML =
            `<strong>ìì‚°ì´ ${endAge}ì„¸ê¹Œì§€ ìœ ì§€ë©ë‹ˆë‹¤.</strong> ì›” ${APP.format.manwon(result.totalMonthly)} ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.`;
        } else {
          statusBox.className = 'info-box danger fade-in';
          document.getElementById('as-status-icon').textContent = 'âš ï¸';
          document.getElementById('as-status-text').innerHTML =
            `<strong>${finalDepletionAge}ì„¸ì— ìì‚°ì´ ì†Œì§„ë©ë‹ˆë‹¤.</strong> ìƒí™œë¹„ë¥¼ ì¤„ì´ê±°ë‚˜ ì¶”ê°€ ì†Œë“ì›ì´ í•„ìš”í•©ë‹ˆë‹¤.`;
        }

        // ì°¨íŠ¸
        const ages = result.assetTimeline.map(d => d.age + 'ì„¸');
        const balances = result.assetTimeline.map(d => Math.round(d.balance / 10000));

        APP.chart.create('asChart', {
          type: 'line',
          data: {
            labels: ages,
            datasets: [{
              label: 'ì”ì—¬ ìì‚° (ë§Œì›)',
              data: balances,
              borderColor: APP.chart.colors.primary,
              backgroundColor: (ctx) => {
                const chart = ctx.chart;
                const {ctx: c, chartArea} = chart;
                if (!chartArea) return APP.chart.colors.primaryAlpha;
                const gradient = c.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                gradient.addColorStop(0, 'rgba(46,139,87,0.3)');
                gradient.addColorStop(1, 'rgba(220,53,69,0.3)');
                return gradient;
              },
              fill: true, tension: 0.3,
            }]
          },
          options: {
            plugins: {
              title: { display: true, text: 'ë³´ìœ  ìì‚° ì¶”ì´ (ë¬¼ê°€ë°˜ì˜)', font: { size: 16 } }
            },
            scales: {
              y: { title: { display: true, text: 'ë§Œì›' }, beginAtZero: true }
            }
          }
        });

        APP.storage.saveForm('rfAssetForm');
        requestAnimationFrame(() => {
          APP.button.reset(calcBtn);
          APP.table.makeCollapsible('#as-timeline-card');
        });
      },

      calcWithdraw() {
        const calcBtn = document.querySelector('#rfWithdrawForm .btn-primary');
        APP.button.loading(calcBtn);
        const form = document.getElementById('rfWithdrawForm');
        const assets = Number(form.assets.value.replace(/[^0-9]/g, '')) * 10000;
        const annualWithdraw = Number(form.annualWithdraw.value.replace(/[^0-9]/g, '')) * 10000;
        const withdrawRate = Number(form.withdrawRate.value) / 100;
        const returnRate = Number(form.returnRate.value) / 100;
        const inflation = Number(form.inflation.value) / 100;
        const simYears = Number(form.simYears.value) || 30;

        const result = CalcEngine.retirementFund.simulateWithdrawal(
          assets, annualWithdraw, withdrawRate, returnRate, inflation, simYears
        );

        document.getElementById('wd-empty').classList.add('hidden');
        document.getElementById('wd-result').classList.remove('hidden');

        // ì†Œì§„ ì—°ë„ ì°¾ê¸°
        const findDepletion = (arr) => {
          const idx = arr.findIndex(v => v <= 0);
          return idx >= 0 ? (idx + 1) + 'ë…„ì°¨ ì†Œì§„' : simYears + 'ë…„ í›„ ' + APP.format.manwon(arr[arr.length - 1]);
        };

        document.getElementById('wd-fixed-last').textContent = APP.format.manwon(result.fixed[result.fixed.length - 1]);
        document.getElementById('wd-fixed-desc').textContent = findDepletion(result.fixed);
        document.getElementById('wd-rate-last').textContent = APP.format.manwon(result.rate[result.rate.length - 1]);
        document.getElementById('wd-rate-desc').textContent = 'ìì‚° ê³ ê°ˆ ì—†ìŒ (ì¸ì¶œì•¡ ê°ì†Œ)';
        document.getElementById('wd-bucket-last').textContent = APP.format.manwon(result.bucket[result.bucket.length - 1]);
        document.getElementById('wd-bucket-desc').textContent = findDepletion(result.bucket);

        // best í‘œì‹œ
        const lastValues = [result.fixed[result.fixed.length-1], result.rate[result.rate.length-1], result.bucket[result.bucket.length-1]];
        const maxIdx = lastValues.indexOf(Math.max(...lastValues));
        document.querySelectorAll('#wd-result .scenario-card').forEach((c, i) => {
          c.classList.toggle('best', i === maxIdx);
        });

        // ì°¨íŠ¸
        const labels = Array.from({length: simYears}, (_, i) => (i + 1) + 'ë…„');

        APP.chart.create('wdChart', {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'ì •ì•¡ ì¸ì¶œ',
                data: result.fixed.map(v => Math.round(v / 10000)),
                borderColor: APP.chart.colors.primary,
                tension: 0.3, fill: false,
              },
              {
                label: 'ì •ë¥  ì¸ì¶œ',
                data: result.rate.map(v => Math.round(v / 10000)),
                borderColor: APP.chart.colors.secondary,
                tension: 0.3, fill: false,
              },
              {
                label: 'ë²„í‚· ì „ëµ',
                data: result.bucket.map(v => Math.round(v / 10000)),
                borderColor: APP.chart.colors.accent,
                tension: 0.3, fill: false,
                borderDash: [5, 5],
              }
            ]
          },
          options: {
            plugins: {
              title: { display: true, text: 'ì¸ì¶œ ì „ëµë³„ ìì‚° ì”ì•¡ ì¶”ì´ (ë§Œì›)', font: { size: 16 } }
            },
            scales: {
              y: { title: { display: true, text: 'ë§Œì›' }, beginAtZero: true }
            }
          }
        });

        APP.storage.saveForm('rfWithdrawForm');
        requestAnimationFrame(() => APP.button.reset(calcBtn));
      },
    };

    document.addEventListener('DOMContentLoaded', () => {
      APP.storage.restoreForm('rfNeedForm');
      APP.storage.restoreForm('rfAssetForm');
      APP.storage.restoreForm('rfWithdrawForm');
    });
  </script>
</body>
</html>
