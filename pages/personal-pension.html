<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê°œì¸ì—°ê¸ˆ ê³„ì‚°ê¸° - ì—°ê¸ˆ í¬í„¸</title>
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/calculator.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
</head>
<body>
  <nav id="main-nav"></nav>

  <div class="container">
    <div class="page-header fade-in">
      <h1 class="page-title">ê°œì¸ì—°ê¸ˆ ê³„ì‚°ê¸°</h1>
      <p class="page-subtitle">ì—°ê¸ˆì €ì¶• ì ë¦½ ì‹œë®¬ë ˆì´ì…˜, ì„¸ì•¡ê³µì œ íš¨ê³¼, ISA ì „í™˜ ë¹„êµë¥¼ ë¶„ì„í•©ë‹ˆë‹¤</p>
    </div>

    <div class="info-box info fade-in">
      <span class="icon">ğŸ’¡</span>
      <div>
        <strong>ì—°ê¸ˆì €ì¶•</strong>: ì—° 1,800ë§Œì› ë‚©ì…í•œë„, ì„¸ì•¡ê³µì œ 600ë§Œì› í•œë„ (IRP í•©ì‚° 900ë§Œì›)<br>
        <strong>ìˆ˜ë ¹ ì‹œ</strong>: ì—°ê¸ˆì†Œë“ì„¸ 3.3~5.5% (ë‚˜ì´ë³„), 1,500ë§Œì› ì´ˆê³¼ ì‹œ ì¢…í•©ê³¼ì„¸ or 15% ë¶„ë¦¬ê³¼ì„¸ ì„ íƒ<br>
        <strong>ISA ì „í™˜</strong>: ISA ë§Œê¸° í›„ ì—°ê¸ˆì „í™˜ ì‹œ ì „í™˜ê¸ˆì•¡ 10%(ìµœëŒ€ 300ë§Œì›) ì¶”ê°€ ì„¸ì•¡ê³µì œ
      </div>
    </div>

    <!-- íƒ­ -->
    <div class="tabs fade-in">
      <button class="tab-btn active" onclick="PersonalPension.switchTab('sim', this)">ì ë¦½ ì‹œë®¬ë ˆì´ì…˜</button>
      <button class="tab-btn" onclick="PersonalPension.switchTab('isa', this)">ISA ì „í™˜ ë¹„êµ</button>
      <button class="tab-btn" onclick="PersonalPension.switchTab('withdraw', this)">ì—°ê¸ˆ ìˆ˜ë ¹ ë¶„ì„</button>
    </div>

    <!-- íƒ­1: ì ë¦½ ì‹œë®¬ë ˆì´ì…˜ -->
    <div class="tab-content active" id="tab-sim">
      <div class="calc-layout">
        <div class="calc-input-panel">
          <div class="card">
            <h2 class="card-title"><span class="card-icon">ğŸ“</span>ì ë¦½ ì¡°ê±´ ì…ë ¥</h2>
            <form id="ppSimForm">
              <div class="input-section">
                <div class="form-group">
                  <label class="form-label">í˜„ì¬ ë‚˜ì´</label>
                  <div class="input-group">
                    <input type="number" class="form-input" name="currentAge" value="40" min="20" max="65">
                    <span class="input-suffix">ì„¸</span>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">ì—°ê¸ˆ ìˆ˜ë ¹ ì‹œì‘ ë‚˜ì´</label>
                  <div class="input-group">
                    <input type="number" class="form-input" name="startAge" value="55" min="55" max="80">
                    <span class="input-suffix">ì„¸</span>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">ì›” ë‚©ì…ì•¡ <span class="unit">(ë§Œì›)</span></label>
                  <div class="input-group">
                    <input type="text" class="form-input" name="monthlyContrib" data-type="money" value="50">
                    <span class="input-suffix">ë§Œì›</span>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">í˜„ì¬ ì ë¦½ê¸ˆ <span class="unit">(ë§Œì›)</span></label>
                  <div class="input-group">
                    <input type="text" class="form-input" name="currentBalance" data-type="money" value="0">
                    <span class="input-suffix">ë§Œì›</span>
                  </div>
                </div>
              </div>

              <div class="input-section">
                <div class="input-section-title">ìˆ˜ìµë¥  ì„¤ì •</div>
                <div class="form-group">
                  <label class="form-label">ì—°ê°„ ì˜ˆìƒ ìˆ˜ìµë¥  <span class="unit">(%)</span></label>
                  <div class="form-range-container">
                    <input type="range" class="form-range" name="returnRate" min="1" max="10" step="0.5" value="4" oninput="document.getElementById('retVal').textContent=this.value+'%'">
                    <span class="range-value" id="retVal">4%</span>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">ì´ê¸‰ì—¬ (ì—°ë´‰) <span class="unit">(ë§Œì›)</span>
                    <span class="tooltip-trigger" data-tooltip="ì„¸ì•¡ê³µì œìœ¨ ê²°ì •ìš©: 5,500ë§Œì› ì´í•˜ 16.5%, ì´ˆê³¼ 13.2%">?</span>
                  </label>
                  <div class="input-group">
                    <input type="text" class="form-input" name="annualSalary" data-type="money" value="5,000">
                    <span class="input-suffix">ë§Œì›</span>
                  </div>
                </div>
              </div>

              <button type="button" class="btn btn-primary btn-block btn-lg" onclick="PersonalPension.calcSim()">ì‹œë®¬ë ˆì´ì…˜</button>
            </form>
          </div>
        </div>

        <div class="calc-result-panel">
          <div id="sim-empty" class="card">
            <div class="empty-result">
              <div class="icon">ğŸ’°</div>
              <div class="text">ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ì‹œë®¬ë ˆì´ì…˜ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
              <div class="sub-text">ì—°ê¸ˆì €ì¶• ì ë¦½ê¸ˆ ì„±ì¥ê³¼ ì„¸ì•¡ê³µì œ íš¨ê³¼ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤</div>
            </div>
          </div>

          <div id="sim-result" style="display:none;">
            <div class="result-banner fade-in">
              <div class="label">ì˜ˆìƒ ì ë¦½ê¸ˆ (ìˆ˜ë ¹ ì‹œì )</div>
              <div class="amount" id="sim-total">-</div>
              <div class="sub" id="sim-info">-</div>
            </div>

            <div class="result-mini-grid fade-in">
              <div class="result-mini">
                <div class="label">ì´ ë‚©ì…ì•¡</div>
                <div class="value" id="sim-contrib">-</div>
              </div>
              <div class="result-mini">
                <div class="label">ìš´ìš©ìˆ˜ìµ</div>
                <div class="value green" id="sim-earnings">-</div>
              </div>
              <div class="result-mini">
                <div class="label">ëˆ„ì  ì„¸ì•¡ê³µì œ</div>
                <div class="value green" id="sim-tax-credit">-</div>
              </div>
              <div class="result-mini">
                <div class="label">ì‹¤ì§ˆ ìˆ˜ìµë¥ </div>
                <div class="value" id="sim-real-return">-</div>
              </div>
            </div>

            <div class="card fade-in">
              <h2 class="card-title"><span class="card-icon">ğŸ“Š</span>ì ë¦½ê¸ˆ ì„±ì¥ ì¶”ì´</h2>
              <div class="chart-container tall">
                <canvas id="simChart"></canvas>
              </div>
            </div>

            <div class="card fade-in">
              <h2 class="card-title"><span class="card-icon">ğŸ“‹</span>ì—°ë„ë³„ ìƒì„¸</h2>
              <div class="table-responsive">
                <table class="data-table" id="sim-table">
                  <thead>
                    <tr>
                      <th>ë‚˜ì´</th>
                      <th>ì—° ë‚©ì…</th>
                      <th>ìš´ìš©ìˆ˜ìµ</th>
                      <th>ì ë¦½ê¸ˆ</th>
                      <th>ì„¸ì•¡ê³µì œ</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- íƒ­2: ISA ì „í™˜ ë¹„êµ -->
    <div class="tab-content" id="tab-isa">
      <div class="calc-layout">
        <div class="calc-input-panel">
          <div class="card">
            <h2 class="card-title"><span class="card-icon">ğŸ“</span>ISA ì „í™˜ ë¹„êµ</h2>
            <form id="isaForm">
              <div class="form-group">
                <label class="form-label">ISA ë§Œê¸° ìê¸ˆ <span class="unit">(ë§Œì›)</span></label>
                <div class="input-group">
                  <input type="text" class="form-input" name="isaAmount" data-type="money" value="3,000">
                  <span class="input-suffix">ë§Œì›</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ISA ë¹„ê³¼ì„¸ ìˆ˜ìµ <span class="unit">(ë§Œì›)</span>
                  <span class="tooltip-trigger" data-tooltip="ì¼ë°˜í˜• 200ë§Œì›, ì„œë¯¼í˜• 400ë§Œì›ê¹Œì§€ ë¹„ê³¼ì„¸">?</span>
                </label>
                <div class="input-group">
                  <input type="text" class="form-input" name="isaProfit" data-type="money" value="200">
                  <span class="input-suffix">ë§Œì›</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ì´ê¸‰ì—¬ <span class="unit">(ë§Œì›)</span></label>
                <div class="input-group">
                  <input type="text" class="form-input" name="isaSalary" data-type="money" value="5,000">
                  <span class="input-suffix">ë§Œì›</span>
                </div>
              </div>
              <button type="button" class="btn btn-primary btn-block btn-lg" onclick="PersonalPension.calcISA()">ë¹„êµí•˜ê¸°</button>
            </form>
          </div>
        </div>

        <div class="calc-result-panel">
          <div id="isa-empty" class="card">
            <div class="empty-result">
              <div class="icon">ğŸ”„</div>
              <div class="text">ISA ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ë¹„êµí•˜ê¸°ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
            </div>
          </div>

          <div id="isa-result" style="display:none;">
            <div class="compare-grid fade-in">
              <div class="compare-card">
                <span class="badge blue">ISA ê·¸ëŒ€ë¡œ ìœ ì§€</span>
                <div class="result-row">
                  <span class="label">ë§Œê¸° ìˆ˜ë ¹ì•¡</span>
                  <span class="value highlight" id="isa-keep-amount">-</span>
                </div>
                <div class="result-row">
                  <span class="label">ë¹„ê³¼ì„¸ í˜œíƒ</span>
                  <span class="value positive" id="isa-keep-benefit">-</span>
                </div>
                <div class="result-row">
                  <span class="label">ì¶”ê°€ ì„¸ì•¡ê³µì œ</span>
                  <span class="value">ì—†ìŒ</span>
                </div>
              </div>

              <div class="compare-vs">VS</div>

              <div class="compare-card recommended">
                <span class="badge green">ì—°ê¸ˆì „í™˜</span>
                <div class="result-row">
                  <span class="label">ì „í™˜ê¸ˆì•¡</span>
                  <span class="value highlight" id="isa-conv-amount">-</span>
                </div>
                <div class="result-row">
                  <span class="label">ì¶”ê°€ ì„¸ì•¡ê³µì œ (10%, ìµœëŒ€ 300ë§Œì›)</span>
                  <span class="value positive" id="isa-conv-extra-base">-</span>
                </div>
                <div class="result-row">
                  <span class="label">ì„¸ì•¡ê³µì œ í™˜ê¸‰</span>
                  <span class="value positive" id="isa-conv-credit">-</span>
                </div>
                <div class="result-row">
                  <span class="label">ì´ í˜œíƒ</span>
                  <span class="value highlight" id="isa-conv-total">-</span>
                </div>
              </div>
            </div>

            <div class="info-box success fade-in">
              <span class="icon">âœ…</span>
              <div id="isa-summary"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- íƒ­3: ì—°ê¸ˆ ìˆ˜ë ¹ ë¶„ì„ -->
    <div class="tab-content" id="tab-withdraw">
      <div class="calc-layout">
        <div class="calc-input-panel">
          <div class="card">
            <h2 class="card-title"><span class="card-icon">ğŸ“</span>ì—°ê¸ˆ ìˆ˜ë ¹ ë¶„ì„</h2>
            <form id="ppWithdrawForm">
              <div class="form-group">
                <label class="form-label">ì ë¦½ê¸ˆ ì´ì•¡ <span class="unit">(ë§Œì›)</span></label>
                <div class="input-group">
                  <input type="text" class="form-input" name="totalBalance" data-type="money" value="10,000">
                  <span class="input-suffix">ë§Œì›</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ìˆ˜ë ¹ ì‹œì‘ ë‚˜ì´</label>
                <div class="input-group">
                  <input type="number" class="form-input" name="withdrawAge" value="55" min="55" max="80">
                  <span class="input-suffix">ì„¸</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ì—°ê°„ ìˆ˜ë ¹ í¬ë§ì•¡ <span class="unit">(ë§Œì›)</span>
                  <span class="tooltip-trigger" data-tooltip="1,500ë§Œì› ì´í•˜: ì €ìœ¨ ë¶„ë¦¬ê³¼ì„¸ (3.3~5.5%), ì´ˆê³¼: ì¢…í•©ê³¼ì„¸ or 15% ë¶„ë¦¬ê³¼ì„¸ ì„ íƒ">?</span>
                </label>
                <div class="input-group">
                  <input type="text" class="form-input" name="annualWithdraw" data-type="money" value="1,200">
                  <span class="input-suffix">ë§Œì›</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ê¸°íƒ€ ì¢…í•©ì†Œë“ <span class="unit">(ë§Œì›/ë…„)</span></label>
                <div class="input-group">
                  <input type="text" class="form-input" name="otherIncome" data-type="money" value="0">
                  <span class="input-suffix">ë§Œì›</span>
                </div>
              </div>
              <button type="button" class="btn btn-primary btn-block btn-lg" onclick="PersonalPension.calcWithdraw()">ë¶„ì„í•˜ê¸°</button>
            </form>
          </div>
        </div>

        <div class="calc-result-panel">
          <div id="wd-empty" class="card">
            <div class="empty-result">
              <div class="icon">ğŸ“‹</div>
              <div class="text">ìˆ˜ë ¹ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ë¶„ì„í•˜ê¸°ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
            </div>
          </div>

          <div id="wd-result" style="display:none;">
            <div class="result-mini-grid fade-in">
              <div class="result-mini">
                <div class="label">ì—°ê°„ ìˆ˜ë ¹ì•¡</div>
                <div class="value" id="wd-annual">-</div>
              </div>
              <div class="result-mini">
                <div class="label">ìˆ˜ë ¹ ê°€ëŠ¥ ê¸°ê°„</div>
                <div class="value" id="wd-years">-</div>
              </div>
              <div class="result-mini">
                <div class="label">ë¶„ë¦¬ê³¼ì„¸ ì—¬ë¶€</div>
                <div class="value" id="wd-separate">-</div>
              </div>
              <div class="result-mini">
                <div class="label">ì—°ê°„ ì„¸ê¸ˆ</div>
                <div class="value red" id="wd-tax">-</div>
              </div>
            </div>

            <!-- ë¶„ë¦¬ê³¼ì„¸ vs ì¢…í•©ê³¼ì„¸ ë¹„êµ -->
            <div class="card fade-in" id="wd-compare-card">
              <h2 class="card-title"><span class="card-icon">âš–ï¸</span>ë¶„ë¦¬ê³¼ì„¸ vs ì¢…í•©ê³¼ì„¸</h2>
              <div class="compare-grid">
                <div class="compare-card" id="wd-sep-card">
                  <span class="badge blue">ë¶„ë¦¬ê³¼ì„¸</span>
                  <div class="result-row">
                    <span class="label">ì„¸ìœ¨</span>
                    <span class="value" id="wd-sep-rate">-</span>
                  </div>
                  <div class="result-row">
                    <span class="label">ì„¸ê¸ˆ</span>
                    <span class="value negative" id="wd-sep-tax">-</span>
                  </div>
                </div>
                <div class="compare-vs">VS</div>
                <div class="compare-card" id="wd-comp-card">
                  <span class="badge orange">ì¢…í•©ê³¼ì„¸</span>
                  <div class="result-row">
                    <span class="label">í•©ì‚°ì†Œë“</span>
                    <span class="value" id="wd-comp-income">-</span>
                  </div>
                  <div class="result-row">
                    <span class="label">ì¶”ê°€ ì„¸ê¸ˆ</span>
                    <span class="value negative" id="wd-comp-tax">-</span>
                  </div>
                </div>
              </div>
              <div class="info-box success" style="margin-top:16px;">
                <span class="icon">âœ…</span>
                <div id="wd-recommend-text"></div>
              </div>
            </div>

            <!-- ì—°ê¸ˆìˆ˜ë ¹ í•œë„ -->
            <div class="card fade-in">
              <h2 class="card-title"><span class="card-icon">ğŸ“‹</span>ì—°ê¸ˆìˆ˜ë ¹ ì—°ì°¨ë³„ í•œë„</h2>
              <div class="info-box warning">
                <span class="icon">âš ï¸</span>
                <div>ì—°ê¸ˆìˆ˜ë ¹í•œë„ë¥¼ ì´ˆê³¼í•˜ì—¬ ì¸ì¶œí•˜ë©´ <strong>ê¸°íƒ€ì†Œë“ì„¸(16.5%)</strong>ê°€ ë¶€ê³¼ë©ë‹ˆë‹¤. í•œë„ ë‚´ì—ì„œ ìˆ˜ë ¹í•˜ì„¸ìš”.</div>
              </div>
              <div class="table-responsive">
                <table class="data-table">
                  <thead>
                    <tr><th>ì—°ì°¨</th><th>ë¶„ëª¨</th><th>ì—°ê°„ í•œë„</th><th>ì›” í•œë„</th></tr>
                  </thead>
                  <tbody id="wd-limit-table"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer id="footer"></footer>

  <script src="../js/constants.js"></script>
  <script src="../js/calculator-engine.js"></script>
  <script src="../js/common.js"></script>
  <script>
    const PersonalPension = {
      switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        btn.classList.add('active');
        APP.input.initMoneyFields();
      },

      calcSim() {
        const form = document.getElementById('ppSimForm');
        const currentAge = Number(form.currentAge.value) || 40;
        const startAge = Number(form.startAge.value) || 55;
        const monthlyContrib = Number(form.monthlyContrib.value.replace(/[^0-9]/g, '')) * 10000;
        const currentBalance = Number(form.currentBalance.value.replace(/[^0-9]/g, '')) * 10000;
        const returnRate = Number(form.returnRate.value) / 100;
        const annualSalary = Number(form.annualSalary.value.replace(/[^0-9]/g, '')) * 10000;

        const years = startAge - currentAge;
        if (years <= 0) {
          alert('ìˆ˜ë ¹ ì‹œì‘ ë‚˜ì´ê°€ í˜„ì¬ ë‚˜ì´ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.');
          return;
        }

        const annualContrib = monthlyContrib * 12;
        // ì„¸ì•¡ê³µì œ í•œë„ ì ìš©
        const taxCreditBase = Math.min(annualContrib, 6000000); // ì—°ê¸ˆì €ì¶• í•œë„ 600ë§Œì›
        const creditRate = annualSalary <= 55000000 ? 0.165 : 0.132;
        const annualTaxCredit = Math.round(taxCreditBase * creditRate);

        // ì‹œë®¬ë ˆì´ì…˜
        let balance = currentBalance;
        let totalContrib = currentBalance;
        let totalTaxCredit = 0;
        const chartLabels = [];
        const chartContrib = [];
        const chartBalance = [];
        const tableRows = [];

        for (let y = 0; y < years; y++) {
          const age = currentAge + y;
          const yearlyReturn = Math.round(balance * returnRate);
          balance += annualContrib + yearlyReturn;
          totalContrib += annualContrib;
          totalTaxCredit += annualTaxCredit;

          chartLabels.push(age + 'ì„¸');
          chartContrib.push(Math.round(totalContrib / 10000));
          chartBalance.push(Math.round(balance / 10000));

          tableRows.push(`
            <tr>
              <td>${age}ì„¸</td>
              <td>${APP.format.manwon(annualContrib)}</td>
              <td>${APP.format.manwon(yearlyReturn)}</td>
              <td>${APP.format.manwon(balance)}</td>
              <td>${APP.format.manwon(annualTaxCredit)}</td>
            </tr>
          `);
        }

        const totalEarnings = balance - totalContrib;
        const realReturn = totalContrib > 0 ? (balance + totalTaxCredit - totalContrib) / totalContrib : 0;

        document.getElementById('sim-empty').style.display = 'none';
        document.getElementById('sim-result').style.display = '';

        document.getElementById('sim-total').textContent = APP.format.manwon(balance);
        document.getElementById('sim-info').textContent = `${currentAge}ì„¸ â†’ ${startAge}ì„¸, ${years}ë…„ ì ë¦½, ìˆ˜ìµë¥  ${(returnRate*100).toFixed(1)}%`;
        document.getElementById('sim-contrib').textContent = APP.format.manwon(totalContrib);
        document.getElementById('sim-earnings').textContent = '+' + APP.format.manwon(totalEarnings);
        document.getElementById('sim-tax-credit').textContent = APP.format.manwon(totalTaxCredit);
        document.getElementById('sim-real-return').textContent = APP.format.percent(realReturn);

        // ì°¨íŠ¸
        APP.chart.create('simChart', {
          type: 'line',
          data: {
            labels: chartLabels,
            datasets: [
              {
                label: 'ì ë¦½ê¸ˆ (ì›ê¸ˆ+ìˆ˜ìµ)',
                data: chartBalance,
                borderColor: APP.chart.colors.primary,
                backgroundColor: APP.chart.colors.primaryAlpha,
                fill: true, tension: 0.3,
              },
              {
                label: 'ëˆ„ì  ë‚©ì…ì•¡',
                data: chartContrib,
                borderColor: APP.chart.colors.accent,
                backgroundColor: APP.chart.colors.accentAlpha,
                fill: true, tension: 0.3,
                borderDash: [5, 5],
              }
            ]
          },
          options: {
            plugins: {
              title: { display: true, text: 'ì—°ê¸ˆì €ì¶• ì ë¦½ê¸ˆ ì„±ì¥ ì¶”ì´ (ë§Œì›)', font: { size: 16 } }
            },
            scales: { y: { title: { display: true, text: 'ë§Œì›' } } }
          }
        });

        // í…Œì´ë¸”
        document.querySelector('#sim-table tbody').innerHTML = tableRows.join('');

        APP.storage.saveForm('ppSimForm');
      },

      calcISA() {
        const form = document.getElementById('isaForm');
        const isaAmount = Number(form.isaAmount.value.replace(/[^0-9]/g, '')) * 10000;
        const isaProfit = Number(form.isaProfit.value.replace(/[^0-9]/g, '')) * 10000;
        const isaSalary = Number(form.isaSalary.value.replace(/[^0-9]/g, '')) * 10000;

        const creditRate = isaSalary <= 55000000 ? 0.165 : 0.132;
        const extraBase = Math.min(isaAmount * 0.1, 3000000); // ì „í™˜ê¸ˆì˜ 10%, ìµœëŒ€ 300ë§Œì›
        const extraCredit = Math.round(extraBase * creditRate);

        document.getElementById('isa-empty').style.display = 'none';
        document.getElementById('isa-result').style.display = '';

        document.getElementById('isa-keep-amount').textContent = APP.format.manwon(isaAmount);
        document.getElementById('isa-keep-benefit').textContent = APP.format.manwon(isaProfit) + ' ë¹„ê³¼ì„¸';
        document.getElementById('isa-conv-amount').textContent = APP.format.manwon(isaAmount);
        document.getElementById('isa-conv-extra-base').textContent = APP.format.manwon(extraBase);
        document.getElementById('isa-conv-credit').textContent = '+' + APP.format.manwon(extraCredit);
        document.getElementById('isa-conv-total').textContent = APP.format.manwon(isaProfit + extraCredit) + ' í˜œíƒ';

        document.getElementById('isa-summary').innerHTML =
          `ISA ë§Œê¸° ìê¸ˆ <strong>${APP.format.manwon(isaAmount)}</strong>ì„ ì—°ê¸ˆì „í™˜í•˜ë©´:<br>` +
          `â€¢ ì¶”ê°€ ì„¸ì•¡ê³µì œ ëŒ€ìƒ: <strong>${APP.format.manwon(extraBase)}</strong><br>` +
          `â€¢ ì„¸ì•¡ê³µì œ í™˜ê¸‰: <strong>${APP.format.manwon(extraCredit)}</strong> (ê³µì œìœ¨ ${APP.format.percent(creditRate)})<br>` +
          `â€¢ ê¸°ì¡´ ë¹„ê³¼ì„¸ í˜œíƒ ${APP.format.manwon(isaProfit)}ë„ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.<br>` +
          `<strong>â€» ISA ë§Œê¸° í›„ 60ì¼ ì´ë‚´</strong>ì— ì—°ê¸ˆê³„ì¢Œë¡œ ì „í™˜í•´ì•¼ í•©ë‹ˆë‹¤.`;
      },

      calcWithdraw() {
        const form = document.getElementById('ppWithdrawForm');
        const totalBalance = Number(form.totalBalance.value.replace(/[^0-9]/g, '')) * 10000;
        const withdrawAge = Number(form.withdrawAge.value) || 55;
        const annualWithdraw = Number(form.annualWithdraw.value.replace(/[^0-9]/g, '')) * 10000;
        const otherIncome = Number(form.otherIncome.value.replace(/[^0-9]/g, '')) * 10000;

        // ìˆ˜ë ¹ ê°€ëŠ¥ ê¸°ê°„
        const withdrawYears = annualWithdraw > 0 ? Math.floor(totalBalance / annualWithdraw) : 0;

        // ë¶„ë¦¬ê³¼ì„¸ í•œë„ ì²´í¬
        const separateLimit = CONSTANTS.TAX.PRIVATE_PENSION_SEPARATE_LIMIT;
        const isSeparable = annualWithdraw <= separateLimit;

        // ë¶„ë¦¬ê³¼ì„¸ vs ì¢…í•©ê³¼ì„¸ ë¹„êµ
        const taxComparison = CalcEngine.tax.comparePrivatePensionTax(annualWithdraw, otherIncome, withdrawAge);

        document.getElementById('wd-empty').style.display = 'none';
        document.getElementById('wd-result').style.display = '';

        document.getElementById('wd-annual').textContent = APP.format.manwon(annualWithdraw);
        document.getElementById('wd-years').textContent = withdrawYears + 'ë…„';
        document.getElementById('wd-separate').textContent = isSeparable ? 'ê°€ëŠ¥ (ì €ìœ¨)' : 'ì„ íƒ ê°€ëŠ¥';

        const recommendedTax = taxComparison.recommended === 'ë¶„ë¦¬ê³¼ì„¸'
          ? taxComparison.separate.totalTax
          : taxComparison.comprehensive.additionalTax;
        document.getElementById('wd-tax').textContent = APP.format.manwon(recommendedTax);

        // ë¹„êµ ì¹´ë“œ
        document.getElementById('wd-sep-rate').textContent = APP.format.percent(taxComparison.separate.rate);
        document.getElementById('wd-sep-tax').textContent = APP.format.manwon(taxComparison.separate.totalTax);
        document.getElementById('wd-comp-income').textContent = APP.format.manwon(taxComparison.comprehensive.totalIncome);
        document.getElementById('wd-comp-tax').textContent = APP.format.manwon(taxComparison.comprehensive.additionalTax);

        const sepCard = document.getElementById('wd-sep-card');
        const compCard = document.getElementById('wd-comp-card');
        if (taxComparison.recommended === 'ë¶„ë¦¬ê³¼ì„¸') {
          sepCard.classList.add('recommended');
          compCard.classList.remove('recommended');
        } else {
          compCard.classList.add('recommended');
          sepCard.classList.remove('recommended');
        }

        document.getElementById('wd-recommend-text').innerHTML =
          `<strong>${taxComparison.recommended}ì´ ìœ ë¦¬í•©ë‹ˆë‹¤.</strong> ` +
          `ì ˆì„¸ íš¨ê³¼: <strong>${APP.format.manwon(taxComparison.saving)}</strong><br>` +
          (isSeparable
            ? `ì—°ê°„ ìˆ˜ë ¹ì•¡ì´ 1,500ë§Œì› ì´í•˜ì´ë¯€ë¡œ ì €ìœ¨ ë¶„ë¦¬ê³¼ì„¸(${APP.format.percent(taxComparison.separate.rate)})ê°€ ì ìš©ë©ë‹ˆë‹¤.`
            : `ì—°ê°„ ìˆ˜ë ¹ì•¡ì´ 1,500ë§Œì›ì„ ì´ˆê³¼í•˜ë¯€ë¡œ 15% ë¶„ë¦¬ê³¼ì„¸ ë˜ëŠ” ì¢…í•©ê³¼ì„¸ ì¤‘ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);

        // ì—°ê¸ˆìˆ˜ë ¹ í•œë„ í…Œì´ë¸”
        const divisors = CONSTANTS.PERSONAL_PENSION.ANNUAL_WITHDRAWAL_DIVISOR;
        let limitBalance = totalBalance;
        const limitRows = [];
        for (let year = 1; year <= 15; year++) {
          const divisor = year <= 5 ? 11 : (year <= 10 ? 9 : 3);
          const annualLimit = Math.round(limitBalance * 1.2 / divisor);
          const monthlyLimit = Math.round(annualLimit / 12);
          limitRows.push(`
            <tr${annualWithdraw > annualLimit ? ' style="background:var(--danger-alpha);"' : ''}>
              <td>${year}ë…„ì°¨</td>
              <td>Ã· ${divisor}</td>
              <td>${APP.format.manwon(annualLimit)}</td>
              <td>${APP.format.manwon(monthlyLimit)}</td>
            </tr>
          `);
          limitBalance -= Math.min(annualWithdraw, annualLimit);
          if (limitBalance <= 0) break;
        }
        document.getElementById('wd-limit-table').innerHTML = limitRows.join('');

        APP.storage.saveForm('ppWithdrawForm');
      },
    };

    document.addEventListener('DOMContentLoaded', () => {
      APP.storage.restoreForm('ppSimForm');
      APP.storage.restoreForm('isaForm');
      APP.storage.restoreForm('ppWithdrawForm');
    });
  </script>
</body>
</html>
